<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>
        Multimodal Chatbot
    </title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        #background-video {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            width: 100%;
            height: 100%;
            z-index: -1;
            object-fit: cover;
            /* This will make the video cover the entire screen */
        }

        body {
            /* Your existing styles */
            /* background-image: url('/static/honey-1810147_1920.jpg'); */
            /* background-size: cover; */
            background-position: center;
            /* background-repeat: no-repeat; */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 16px;
            color: #333;

            /* Additional styles for bulged effect */
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* border: 10px solid transparent; */
            /* border-radius: 20px; */
            /* Adjust the border-radius for more or less curvature */
            /* background-clip: padding-box; */
            /* Prevents the background from bleeding into the border */
            /* box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); */
            /* Adds depth with a shadow */
            /* transform: scale(1.02); */
            /* Slightly scales up the body to give a bulged effect */
        }

        .chat-container {
            width: 150%;
            height: 85%;
            max-width: 1200px;
            max-height: 910px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            resize: scroll;
            background-color: rgba(255, 255, 255, 0.5);
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.5);
            transform: rotateY(10deg) rotateX(5deg);
        }

        .chat-header {
            background-color: #531414;
            color: #ffffff;
            padding: 15px;
            text-align: center;
        }

        .chat-body {
            padding: 20px;
            height: 650px;
            overflow-y: auto;
            resize: scroll;
            background-color: rgba(255, 255, 255, 0.2);
            /* Adjust the alpha value as needed */
            color: #ffffff;
        }

        .chat-footer textarea {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-right: 10px;
            resize: vertical;
            /* Allow vertical resizing, you can also use 'both' to allow both vertical and horizontal resizing */
            overflow: auto;
            /* Ensure scrollbar appears when text exceeds the area */
        }

        .chat-footer input[type="text"] {
            width: 70%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-right: 10px;
        }

        .chat-footer input[type="submit"] {
            background-color: #5d647b;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .chat-footer input[type="submit"]:hover {
            background-color: #4b5268;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 4px;
            background-color: #fff;
            box-shadow: 0 2px 2px rgba(0, 0, 0, 0.1);
        }

        .message.user {
            background-color: #161f2c;
            align-self: flex-end;
        }

        .message.bot {
            background-color: #351919;
            align-self: flex-start;
        }

        @media (max-width: 768px) {
            .chat-container {
                width: 95%;
                max-width: 600px;
            }

            .chat-body {
                height: 300px;
            }

            body {
                font-size: 16px;
            }
        }

        .centered-container {
            display: flex;
            /* Use Flexbox */
            justify-content: center;
            /* Center horizontally */
            align-items: center;
            /* Center vertically */
            height: 10vh;
            /* Full height of the viewport */
        }

        /* Your existing button styles */
        .custom-button {
            background-color: transparent;
            width: 160px;
            height: 40px;
            border: none;
            color: rgb(255, 255, 255);
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s ease;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .submit-button:hover,
        .upload-button:hover,
        .record-button:hover {
            background-color: #3c59aa;
        }

        .upload-button {
            background-image: url('/static/upload_button.png');
        }

        .record-button {
            background-image: url('/static/record_button.png');
        }

        pre {
            background-color: #000;
            /* Change to black */
            border: 1px solid #ddd;
            border-left: 3px solid #f36d33;
            color: #fff;
            /* Change text color to white */
            page-break-inside: avoid;
            font-family: monospace;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 1.6em;
            max-width: 100%;
            overflow: auto;
            padding: 1em 1.5em;
            display: block;
            word-wrap: break-word;
        }

        code {
            background-color: #000;
            /* Change to black */
            border-radius: 3px;
            font-family: monospace;
            padding: 0.2em 0.4em;
            color: #fff;
            /* Change text color to white */
        }

        /* Sidebar styles */
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 300px;
            /* Width of the sidebar */
            background-color: #312c2c;
            overflow-x: hidden;
            padding: 20px;
            transition: 0.5s;
            /* Transition for the animation */
            z-index: 1000;
            /* Ensure the sidebar is above other content */
        }

        /* Positioning the sidebars */
        #leftSidebar {
            left: -300px;
            /* Start off-screen to the left */
        }

        #rightSidebar {
            right: -300px;
            /* Start off-screen to the right */
        }

        /* Class to toggle the sidebar visibility */
        .sidebar.open {
            left: 0;
            /* For left sidebar */
            right: 0;
            /* For right sidebar */
        }
    </style>
</head>

<body>
    <!-- Video as background -->
    <video autoplay loop muted id="background-video"
        style="position: fixed; right: 0; bottom: 0; min-width: 100%; min-height: 100%; z-index: -1;">
        <source src="/static/red_black.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <div class="chat-container">
        <div class="chat-header">
            <img src="/static/AI_RT_White.jpg" alt="Logo" style="height: 75px;"> <!-- Add your logo here -->
            <h1>Multimodal Chatbot</h1>
        </div>
        <div class="chat-body" id="chatBody">
            <!-- Chat messages will be dynamically added here -->
        </div>
        <div class="chat-footer">
            <textarea id="userInput" placeholder="Type your message here..." rows="3"></textarea>
            <input type="file" id="fileInput" style="display: none;"> <!-- Hidden file input -->
        </div>
        <!-- Left Sidebar -->
        <div id="leftSidebar" class="sidebar">
            <!-- Content for the left sidebar -->
            <button class="clear-button submit-button" onclick="clearChat()">Clear Chat</button>
        </div>
        <!-- Right Sidebar -->
        <div id="rightSidebar" class="sidebar">
            <!-- Content for the right sidebar -->
        </div>
        <div class="centered-container">
            <button type="submit" class="custom-button submit-button" onclick="sendMessage()">Send</button>
            <button class="custom-button upload-button" aria-label="Upload File"
                onclick="document.getElementById('fileInput').click()"></button>
            <button class="custom-button record-button" aria-label="Record Audio" id="recordButton"></button>
            <!-- Buttons to toggle sidebars -->
            <button class="custom-button submit-button" onclick="toggleSidebar('leftSidebar')">Settings</button>
            <button class="custom-button submit-button" onclick="toggleSidebar('rightSidebar')">Content</button>
            <button class="custom-button submit-button" onclick="clearChat()">Clear Chat</button>
        </div>
    </div>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js"></script>

    <!-- JavaScript functions communicating with app.py -->
    <script>
        function clearChat() {
            var chatBody = document.getElementById('chatBody');
            chatBody.innerHTML = ''; // Clear all chat messages
        }
        function sendMessage() {
            var inputField = document.getElementById('userInput');
            var message = inputField.value.trim();
            if (message !== "") {
                // Display user message
                var userMessageDiv = document.createElement('div');
                userMessageDiv.classList.add('message', 'user');
                userMessageDiv.textContent = message;
                document.getElementById('chatBody').appendChild(userMessageDiv);

                // Send message to chatbot and get response
                fetch('/chat', {
                    method: 'POST',
                    body: new URLSearchParams({ 'message': message }),
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        handleChatbotResponse(data.response);
                    });
                // Fetch the chat response and audio URL
                fetch('/chat', {
                    method: 'POST',
                    body: new URLSearchParams({ 'message': message }),
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        handleChatbotResponse(data.response, data.audio_url);
                    });

                // Clear input field
                inputField.value = '';
            }
        }
        // function toggleSidebar(sidebarId) {
        //     var sidebar = document.getElementById(sidebarId);
        //     if (sidebar.classList.contains('open')) {
        //         sidebar.classList.remove('open');
        //     } else {
        //         sidebar.classList.add('open');
        //     }
        // }
        function toggleSidebar(sidebarId) {
            var sidebar = document.getElementById(sidebarId);
            if (sidebar.style.left === '0px' || sidebar.style.right === '0px') {
                // Sidebar is open, close it
                sidebar.style.left = sidebar.style.right = '-300px';
            } else {
                // Sidebar is closed, open it
                sidebar.style.left = sidebar.style.right = '0px';
            }
        }



        // Function to handle chatbot response
        function handleChatbotResponse(response) {
            // Create a new div for the bot message
            var botMessageDiv = document.createElement('div');
            botMessageDiv.classList.add('message', 'bot');

            // Regular expression to match code blocks
            var codeBlockRegex = /```(.*?)```/gs;

            // Split the response into parts by code blocks
            var parts = response.split(codeBlockRegex);

            // Iterate over the parts and handle text and code separately
            parts.forEach((part, index) => {
                // Check if this part is a code snippet (odd indices are code snippets)
                if (index % 2 === 1) {
                    // Create a pre element to preserve formatting
                    var pre = document.createElement('pre');

                    // Create a code element to style the code snippet
                    var code = document.createElement('code');
                    code.classList.add('language-javascript'); // Specify the language for syntax highlighting
                    code.textContent = part;

                    // Append the code element to the pre element
                    pre.appendChild(code);

                    // Use Prism to highlight the code
                    Prism.highlightElement(code);

                    // Append the pre element to the bot message div
                    botMessageDiv.appendChild(pre);
                } else {
                    // This part is regular text
                    // Create a span element for the text
                    var textSpan = document.createElement('span');
                    textSpan.textContent = part;

                    // Append the text span to the bot message div
                    botMessageDiv.appendChild(textSpan);
                    // Create an audio element to play the response
                    var audioPlayer = document.createElement('audio');
                    audioPlayer.src = audioUrl;
                    audioPlayer.controls = true;
                    audioPlayer.style = "width: 100%;"; // Set the width of the audio player

                    // Append the audio player to the bot message div
                    botMessageDiv.appendChild(audioPlayer);

                    // Append the bot message div to the chat body
                    document.getElementById('chatBody').appendChild(botMessageDiv);
                }
            });

            // Append the bot message div to the chat body
            document.getElementById('chatBody').appendChild(botMessageDiv);
        }

        // Function to handle file upload
        var fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', function (event) {
            var file = event.target.files[0];
            var formData = new FormData();
            formData.append('file', file, file.name);

            fetch('/upload', {
                method: 'POST',
                body: formData,
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data.message);
                });
        });

        // Function to handle voice recording
        var recordButton = document.getElementById('recordButton');
        var mediaRecorder;
        var audioChunks = [];

        recordButton.addEventListener('click', function () {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function (stream) {
                        mediaRecorder = new MediaRecorder(stream);
                        mediaRecorder.ondataavailable = function (event) {
                            audioChunks.push(event.data);
                        };
                        mediaRecorder.onstop = function () {
                            var audioBlob = new Blob(audioChunks, { 'type': 'audio/wav' });
                            var formData = new FormData();
                            formData.append('audio', audioBlob, 'recording.wav');

                            fetch('/voice', {
                                method: 'POST',
                                body: formData,
                            })
                                .then(response => response.json())
                                .then(data => {
                                    console.log(data.message);
                                });

                            recordButton.textContent = 'Record Voice';
                        };
                        mediaRecorder.start();
                        recordButton.textContent = 'Recording...';
                        audioChunks = [];
                    });
            } else if (mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        });
        document.getElementById('userInput').addEventListener('keydown', function (event) {
            if (event.key === 'Enter' && !event.shiftKey) { // Check if Enter is pressed without the Shift key
                sendMessage();
                event.preventDefault(); // Prevent the default behavior of Enter which is a new line in textarea
            }
        });


    </script>
</body>

</html>